<!DOCTYPE html>
<html>
	<head>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="utf-8" />
		<link rel="stylesheet" type="text/css" href="css/style.css" />
		<title>Python 应用之一：基本财务分析</title>
	</head>
<body>
<h2>Python 应用之一：基本财务分析</h2>

<p>一、结果</p>

<p>每一种产品在某一周的工作日店均日均销售数量、销售成本、销售收入、销售毛利和销售毛利率</p>

<figure><img src="%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-30%20%E4%B8%8A%E5%8D%8810.28.06.png"/></figure>

<p>二、数据源</p>

<ul>
	<li>商品销售明细，包含字段：订单日期，商品名称，订单价格，商品销售数量，商品成本等

		<figure><img src="%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-30%20%E4%B8%8A%E5%8D%8810.43.03.png"/></figure></li>
	<li>店铺明细，包含字段：店铺名称，开店日期，闭店日期等

		<figure><img src="%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-30%20%E4%B8%8A%E5%8D%8810.43.15.png"/></figure></li>
</ul>

<p>三、其他数据</p>

<ul>
	<li>日期Mapping，包含字段：日期，日期处于第几周，日期是星期几，工作日/节假日

		<figure><img src="%E5%B1%8F%E5%B9%95%E5%BF%AB%E7%85%A7%202018-06-30%20%E4%B8%8A%E5%8D%8810.42.34.png"/></figure></li>
</ul>

<p>四、使用的模块</p>

<ul>
	<li>pandas</li>
	<li>xlrd</li>
	<li>datetime</li>
	<li>time</li>
</ul>

<p>五、涉及知识点</p>

<ul>
	<li>读取Excel文件里的数据并将数据转化为DataFrame</li>
	<li>合并不同Excel文件的数据（相当于Vlookup）</li>
	<li>清理DataFrame里的无效和重复字段</li>
	<li>转换日期字符串为datetime对象</li>
	<li>对数据进行聚合计算（相当于PivotTable）</li>
	<li>DataFrame转换index为column</li>
	<li>调整输出数据的格式</li>
</ul>

<hr />

<p>知识点一：读取Excel文件里的数据并将数据转化为DataFrame</p>

<pre><code class="code-highlighted code-python"><span class="syntax-all syntax-keyword">def</span> <span class="syntax-all syntax-entity">read_excel_workbook</span>(<span class="syntax-all syntax-parameter">path</span>):
	workbook <span class="syntax-all syntax-keyword">=</span> xlrd.open_workbook(path)
	sheet <span class="syntax-all syntax-keyword">=</span> workbook.sheet_by_index(<span class="syntax-all syntax-constant">0</span>)
	data <span class="syntax-all syntax-keyword">=</span> {}
	<span class="syntax-all syntax-keyword">for</span> i <span class="syntax-all syntax-keyword">in</span> <span class="syntax-all syntax-constant">range</span>(sheet.ncols):
		<span class="syntax-all syntax-comment"># 按列读取数据，第一个数据是列的的名字,剩下的数据是列的值
</span>		h, <span class="syntax-all syntax-keyword">*</span>rest <span class="syntax-all syntax-keyword">=</span> sheet.col_values(i)
		data[h] <span class="syntax-all syntax-keyword">=</span> rest
	frame <span class="syntax-all syntax-keyword">=</span> pd.DataFrame(data)
	<span class="syntax-all syntax-keyword">return</span> frame</code></pre>

<p>知识点二：合并不同Excel文件的数据（相当于Vlookup）</p>

<pre><code class="code-highlighted code-python">dataSource <span class="syntax-all syntax-keyword">=</span> read_excel_workbook(<span class="syntax-all syntax-string">&#39;/Volumes/Transcend/Blianlifeng/专题数据/果汁/datasource.xlsx&#39;</span>)
storeMapping <span class="syntax-all syntax-keyword">=</span> read_excel_workbook(<span class="syntax-all syntax-string">&#39;/Volumes/Transcend/Blianlifeng/专题数据/果汁/store_Mapping.xlsx&#39;</span>)
<span class="syntax-all syntax-comment"># pd.merge: 前两个参数是待合并数据，&lt;how&gt;规定了合并的类型，&lt;on&gt;规定了关联的字段，这个字段同时存在于两个数据源，如果字段名不一致，可以用&lt;left_on&gt;,&lt;right_on&gt;
</span>dataSource <span class="syntax-all syntax-keyword">=</span> pd.merge(dataSource,storeMapping[[<span class="syntax-all syntax-string">&#39;store_code&#39;</span>,<span class="syntax-all syntax-string">&#39;批次&#39;</span>]],<span class="syntax-all syntax-parameter">how</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;inner&#39;</span>,<span class="syntax-all syntax-parameter">on</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;store_code&#39;</span>)
dataSource <span class="syntax-all syntax-keyword">=</span> pd.merge(dataSource,dateDataFrame,<span class="syntax-all syntax-parameter">how</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;inner&#39;</span>,<span class="syntax-all syntax-parameter">on</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-constant">None</span>,<span class="syntax-all syntax-parameter">left_on</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;order_date&#39;</span>,<span class="syntax-all syntax-parameter">right_on</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;date&#39;</span>)</code></pre>

<p>知识点三：清理DataFrame里的无效和重复字段</p>

<pre><code class="code-highlighted code-python">dataSource.drop([<span class="syntax-all syntax-string">&#39;type&#39;</span>,<span class="syntax-all syntax-string">&#39;date&#39;</span>],<span class="syntax-all syntax-parameter">axis</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;columns&#39;</span>,<span class="syntax-all syntax-parameter">inplace</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-constant">True</span>)</code></pre>

<p>知识点四：转换日期字符串为datetime对象</p>

<pre><code class="code-highlighted code-python"><span class="syntax-all syntax-keyword">def</span> <span class="syntax-all syntax-entity">ChangeDateFormat</span>(<span class="syntax-all syntax-parameter">x</span>):
	<span class="syntax-all syntax-keyword">if</span> x.count(<span class="syntax-all syntax-string">&#39;/&#39;</span>)<span class="syntax-all syntax-keyword">&gt;</span><span class="syntax-all syntax-constant">0</span>:
		dt <span class="syntax-all syntax-keyword">=</span> time.strptime(x,<span class="syntax-all syntax-string">&#39;</span><span class="syntax-all syntax-constant">%Y</span><span class="syntax-all syntax-string">/</span><span class="syntax-all syntax-constant">%m</span><span class="syntax-all syntax-string">/</span><span class="syntax-all syntax-constant">%d</span><span class="syntax-all syntax-string">&#39;</span>)
	<span class="syntax-all syntax-keyword">elif</span> x.count(<span class="syntax-all syntax-string">&#39;-&#39;</span>)<span class="syntax-all syntax-keyword">&gt;</span><span class="syntax-all syntax-constant">0</span>:
		dt <span class="syntax-all syntax-keyword">=</span> time.strptime(x,<span class="syntax-all syntax-string">&#39;</span><span class="syntax-all syntax-constant">%Y</span><span class="syntax-all syntax-string">-</span><span class="syntax-all syntax-constant">%m</span><span class="syntax-all syntax-string">-</span><span class="syntax-all syntax-constant">%d</span><span class="syntax-all syntax-string">&#39;</span>)
	dtStamp <span class="syntax-all syntax-keyword">=</span> time.mktime(dt)
	dtDateTime <span class="syntax-all syntax-keyword">=</span> datetime.datetime.fromtimestamp(dtStamp)
	<span class="syntax-all syntax-keyword">return</span> dtDateTime</code></pre>

<p>知识点五： 对数据进行聚合计算（相当于PivotTable）</p>

<pre><code class="code-highlighted code-python">sum1 <span class="syntax-all syntax-keyword">=</span> dataSource[dataSource[<span class="syntax-all syntax-string">&#39;dayType&#39;</span>]<span class="syntax-all syntax-keyword">==</span><span class="syntax-all syntax-string">&#39;工作日&#39;</span>][[<span class="syntax-all syntax-string">&#39;cost_total&#39;</span>,<span class="syntax-all syntax-string">&#39;sku_cnt&#39;</span>,<span class="syntax-all syntax-string">&#39;payable_price_total&#39;</span>]].groupby([dataSource[<span class="syntax-all syntax-string">&#39;weekNum&#39;</span>],dataSource[<span class="syntax-all syntax-string">&#39;order_date&#39;</span>],dataSource[<span class="syntax-all syntax-string">&#39;sku_name&#39;</span>]]).sum()
sum2 <span class="syntax-all syntax-keyword">=</span> sum1[[<span class="syntax-all syntax-string">&#39;avgSkuCnt&#39;</span>,<span class="syntax-all syntax-string">&#39;avgPayPriceTotal&#39;</span>,<span class="syntax-all syntax-string">&#39;avgCost&#39;</span>]].groupby([sum1[<span class="syntax-all syntax-string">&#39;weekNum&#39;</span>],sum1[<span class="syntax-all syntax-string">&#39;sku_name&#39;</span>]]).mean()</code></pre>

<p>知识点六：DataFrame转换index为column</p>

<pre><code class="code-highlighted code-python"><span class="syntax-all syntax-comment"># 将合并计算后的DataFrame的index转化为column,然后与其他数据关联
</span>sum1 <span class="syntax-all syntax-keyword">=</span> pd.merge(sum1.reset_index(),dateDataFrame[[<span class="syntax-all syntax-string">&#39;date&#39;</span>,<span class="syntax-all syntax-string">&#39;storeCount&#39;</span>]],<span class="syntax-all syntax-parameter">how</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;inner&#39;</span>,<span class="syntax-all syntax-parameter">left_on</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;order_date&#39;</span>,<span class="syntax-all syntax-parameter">right_on</span><span class="syntax-all syntax-keyword">=</span><span class="syntax-all syntax-string">&#39;date&#39;</span>)</code></pre>

<p>知识点七：调整输出数据的格式</p>

<pre><code class="code-highlighted code-python"><span class="syntax-all syntax-comment"># 定义函数：
</span>float_format <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-keyword">lambda</span> x : <span class="syntax-all syntax-string">&#39;</span><span class="syntax-all syntax-constant">%.2f</span><span class="syntax-all syntax-string">&#39;</span> <span class="syntax-all syntax-keyword">%</span> x
percent_format <span class="syntax-all syntax-keyword">=</span> <span class="syntax-all syntax-keyword">lambda</span> x :<span class="syntax-all syntax-string">&#39;</span><span class="syntax-all syntax-constant">%.2f%%</span><span class="syntax-all syntax-string">&#39;</span> <span class="syntax-all syntax-keyword">%</span> (x <span class="syntax-all syntax-keyword">*</span> <span class="syntax-all syntax-constant">100</span>)
<span class="syntax-all syntax-comment"># DataFrame使用applymap, Series使用map
</span>sum2[[<span class="syntax-all syntax-string">&#39;avgSkuCnt&#39;</span>,<span class="syntax-all syntax-string">&#39;avgCost&#39;</span>,<span class="syntax-all syntax-string">&#39;avgPayPriceTotal&#39;</span>,<span class="syntax-all syntax-string">&#39;avgProfit&#39;</span>]] <span class="syntax-all syntax-keyword">=</span> sum2[[<span class="syntax-all syntax-string">&#39;avgSkuCnt&#39;</span>,<span class="syntax-all syntax-string">&#39;avgCost&#39;</span>,<span class="syntax-all syntax-string">&#39;avgPayPriceTotal&#39;</span>,<span class="syntax-all syntax-string">&#39;avgProfit&#39;</span>]].applymap(float_format)
sum2[<span class="syntax-all syntax-string">&#39;avgProfitRate&#39;</span>] <span class="syntax-all syntax-keyword">=</span> sum2[<span class="syntax-all syntax-string">&#39;avgProfitRate&#39;</span>].map(percent_format)</code></pre>

</body>
</html>

